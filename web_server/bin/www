#!/usr/bin/env lsc

require! {
  '../app'
  'http'
  'http-proxy'
}

proxy = httpProxy.createProxyServer!

debug = require('debug')('web_server:server')

server = http.createServer app

bundle = require '../server/bundle.js'
bundle!

app.all '/build/*', (req, res) ->
  proxy.web req, res, target: 'http://localhost:8080'


proxy.on 'error', (e) ->
  console.log('Could not connect to proxy, please try again...')


server.on 'error', (error) ->
  | error.syscall isnt 'listen'  =>  throw error

  switch error.code
  | 'EACCES'  =>
      console.error 'Port requires elevated privileges'
      process.exit 1
  | 'EADDRINUSE'  =>
      console.error 'Port is already in use'
      process.exit 1
  | _  => throw error


server.on 'listening', ->
  debug "Listening on port #{server.address!port}"


server.listen parse-int(process.env.PORT or '3000')
